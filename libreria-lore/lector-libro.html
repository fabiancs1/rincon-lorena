<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Los Siete Maridos de Evelyn Hugo ‚Äî Loran</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
  :root {
    --cream: #f7f0e3;
    --warm: #e8d9bb;
    --rose: #c9748a;
    --deep-rose: #a0435a;
    --gold: #c9a84c;
    --brown: #5c3d2e;
    --dark: #2c1810;
    --page-bg: #fdf8ee;
    --shadow: rgba(44, 24, 16, 0.3);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #1a0e08;
    font-family: 'Cormorant Garamond', serif;
    color: var(--dark);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background-image: 
      radial-gradient(ellipse at 30% 40%, rgba(160,67,90,0.12) 0%, transparent 60%),
      radial-gradient(ellipse at 70% 60%, rgba(201,168,76,0.08) 0%, transparent 60%);
  }

  /* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 28px;
    background: rgba(10,4,2,0.85);
    border-bottom: 1px solid rgba(201,168,76,0.2);
    backdrop-filter: blur(8px);
    flex-shrink: 0;
    z-index: 10;
  }

  .topbar-title {
    font-family: 'Playfair Display', serif;
    font-size: 0.95rem;
    color: var(--gold);
    font-style: italic;
    letter-spacing: 0.03em;
  }

  .topbar-sub {
    font-size: 0.75rem;
    color: rgba(201,168,76,0.5);
    margin-top: 2px;
  }

  .topbar-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .page-indicator {
    color: rgba(255,255,255,0.45);
    font-size: 0.82rem;
    font-style: italic;
    min-width: 100px;
    text-align: right;
  }

  .back-btn {
    background: none;
    border: 1px solid rgba(201,168,76,0.3);
    color: var(--gold);
    padding: 6px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.85rem;
    transition: all 0.2s;
  }

  .back-btn:hover { background: rgba(201,168,76,0.1); }

  /* ‚îÄ‚îÄ MAIN STAGE ‚îÄ‚îÄ */
  .stage {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    overflow: hidden;
    position: relative;
  }

  /* ‚îÄ‚îÄ BOOK WRAPPER ‚îÄ‚îÄ */
  .book-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    gap: 0;
  }

  /* ‚îÄ‚îÄ THE BOOK ‚îÄ‚îÄ */
  .book {
    position: relative;
    display: flex;
    filter: drop-shadow(0 30px 60px rgba(0,0,0,0.7));
  }

  /* Page sides */
  .page-side {
    background: var(--page-bg);
    overflow: hidden;
    position: relative;
    flex-shrink: 0;
  }

  .page-left {
    border-radius: 4px 0 0 4px;
    box-shadow: inset -4px 0 10px rgba(0,0,0,0.08);
  }

  .page-right {
    border-radius: 0 4px 4px 0;
    box-shadow: inset 4px 0 10px rgba(0,0,0,0.08);
  }

  /* Spine */
  .spine {
    width: 16px;
    background: linear-gradient(to right, #c8a87a, #e8d4a8, #c8a87a);
    flex-shrink: 0;
    position: relative;
    z-index: 2;
    box-shadow: 0 0 8px rgba(0,0,0,0.3);
  }

  /* Canvas inside pages */
  .page-side canvas {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  /* Page texture overlay */
  .page-side::after {
    content: '';
    position: absolute;
    inset: 0;
    pointer-events: none;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 28px,
      rgba(180,150,100,0.04) 28px,
      rgba(180,150,100,0.04) 29px
    );
    z-index: 3;
  }

  /* Page number */
  .page-num {
    position: absolute;
    bottom: 12px;
    font-size: 0.72rem;
    color: var(--brown);
    opacity: 0.5;
    font-style: italic;
    z-index: 4;
  }

  .page-left .page-num { right: 20px; }
  .page-right .page-num { left: 20px; }

  /* ‚îÄ‚îÄ FLIP ANIMATION ‚îÄ‚îÄ */
  .flip-container {
    position: absolute;
    top: 0;
    width: 50%;
    height: 100%;
    pointer-events: none;
    z-index: 10;
    perspective: 2000px;
  }

  .flip-container.flip-right { left: 50%; transform-origin: left center; }
  .flip-container.flip-left  { left: 0;   transform-origin: right center; }

  .flip-page {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0; left: 0;
    transform-style: preserve-3d;
    transform-origin: inherit;
    background: var(--page-bg);
    backface-visibility: hidden;
    box-shadow: 4px 0 20px rgba(0,0,0,0.3);
  }

  .flip-page canvas {
    width: 100%; height: 100%;
    display: block;
  }

  /* Flip animation forward (right page turns left) */
  @keyframes flipForward {
    0%   { transform: rotateY(0deg); box-shadow: 4px 0 20px rgba(0,0,0,0.3); }
    40%  { box-shadow: -20px 0 40px rgba(0,0,0,0.4); }
    100% { transform: rotateY(-180deg); box-shadow: 4px 0 5px rgba(0,0,0,0.1); }
  }

  @keyframes flipBack {
    0%   { transform: rotateY(0deg); }
    100% { transform: rotateY(180deg); }
  }

  .flip-container.animating-forward .flip-page {
    animation: flipForward 0.65s cubic-bezier(0.645, 0.045, 0.355, 1.000) forwards;
  }

  .flip-container.animating-back .flip-page {
    animation: flipBack 0.65s cubic-bezier(0.645, 0.045, 0.355, 1.000) forwards;
  }

  /* ‚îÄ‚îÄ NAV ARROWS ‚îÄ‚îÄ */
  .nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(201,168,76,0.12);
    border: 1px solid rgba(201,168,76,0.3);
    color: var(--gold);
    width: 44px; height: 44px;
    border-radius: 50%;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
    z-index: 20;
    backdrop-filter: blur(4px);
  }

  .nav-btn:hover { background: rgba(201,168,76,0.25); transform: translateY(-50%) scale(1.08); }
  .nav-btn:disabled { opacity: 0.2; cursor: default; }
  .nav-btn:disabled:hover { transform: translateY(-50%) scale(1); background: rgba(201,168,76,0.12); }

  .nav-prev { left: -56px; }
  .nav-next { right: -56px; }

  /* ‚îÄ‚îÄ BOTTOM BAR ‚îÄ‚îÄ */
  .bottombar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    padding: 12px 28px;
    background: rgba(10,4,2,0.7);
    border-top: 1px solid rgba(201,168,76,0.15);
    flex-shrink: 0;
  }

  .progress-wrap {
    flex: 1;
    max-width: 400px;
    height: 3px;
    background: rgba(255,255,255,0.1);
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(to right, var(--deep-rose), var(--gold));
    border-radius: 2px;
    transition: width 0.4s ease;
    width: 0%;
  }

  .progress-label {
    color: rgba(255,255,255,0.3);
    font-size: 0.75rem;
    font-style: italic;
    white-space: nowrap;
  }

  /* ‚îÄ‚îÄ LOADING SCREEN ‚îÄ‚îÄ */
  #loadScreen {
    position: fixed;
    inset: 0;
    background: #1a0e08;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    gap: 24px;
    transition: opacity 0.6s ease;
  }

  #loadScreen.hidden { opacity: 0; pointer-events: none; }

  .load-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.6rem;
    color: var(--gold);
    font-style: italic;
    text-align: center;
  }

  .load-sub {
    color: rgba(255,255,255,0.3);
    font-size: 0.85rem;
    font-style: italic;
  }

  .spinner {
    width: 40px; height: 40px;
    border: 2px solid rgba(201,168,76,0.15);
    border-top-color: var(--gold);
    border-radius: 50%;
    animation: spin 0.9s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* Upload prompt */
  #uploadPrompt {
    position: fixed;
    inset: 0;
    background: #1a0e08;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 999;
    gap: 20px;
    padding: 30px;
  }

  #uploadPrompt.hidden { display: none; }

  .upload-box {
    border: 2px dashed rgba(201,168,76,0.4);
    border-radius: 20px;
    padding: 60px 50px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    max-width: 460px;
    width: 100%;
  }

  .upload-box:hover { border-color: var(--rose); background: rgba(201,116,138,0.05); }

  .upload-box .icon { font-size: 3rem; margin-bottom: 16px; }

  .upload-box h2 {
    font-family: 'Playfair Display', serif;
    color: var(--gold);
    font-size: 1.4rem;
    margin-bottom: 10px;
    font-style: italic;
  }

  .upload-box p { color: rgba(255,255,255,0.35); font-size: 0.9rem; font-style: italic; }

  .upload-btn {
    background: linear-gradient(135deg, var(--deep-rose), var(--rose));
    color: white;
    border: none;
    padding: 14px 36px;
    border-radius: 30px;
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.05rem;
    cursor: pointer;
    letter-spacing: 0.05em;
    transition: all 0.3s;
  }

  .upload-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(160,67,90,0.4); }

  .or-label { color: rgba(255,255,255,0.2); font-size: 0.8rem; }

  /* Responsive */
  @media (max-width: 700px) {
    .nav-prev { left: 4px; }
    .nav-next { right: 4px; }
    .spine { width: 10px; }
  }
</style>
</head>
<body>

<!-- Upload Prompt -->
<div id="uploadPrompt">
  <div class="upload-box" onclick="document.getElementById('pdfInput').click()">
    <div class="icon">üìñ</div>
    <h2>La Biblioteca de Loran</h2>
    <p>Sube el PDF del libro para comenzar a leer</p>
  </div>
  <p class="or-label">‚Äî o arrastra el PDF aqu√≠ ‚Äî</p>
  <button class="upload-btn" onclick="document.getElementById('pdfInput').click()">Seleccionar PDF üåπ</button>
  <input type="file" id="pdfInput" accept=".pdf" style="display:none" onchange="loadPDF(event)">
</div>

<!-- Loading Screen -->
<div id="loadScreen" class="hidden" style="display:none">
  <div class="spinner"></div>
  <p class="load-title">Preparando tu libro...</p>
  <p class="load-sub">Esto tomar√° solo un momento üåπ</p>
</div>

<!-- TOP BAR -->
<div class="topbar" id="topbar" style="display:none">
  <div>
    <div class="topbar-title" id="bookTitle">Los siete maridos de Evelyn Hugo</div>
    <div class="topbar-sub">Taylor Jenkins Reid</div>
  </div>
  <div class="topbar-right">
    <span class="page-indicator" id="pageIndicator">P√°gina 1</span>
    <button class="back-btn" id="bookmarkBtn" style="display:none; border-color:rgba(201,116,138,0.4); color:var(--rose);" onclick="handleBookmarkBtn()">üéÄ Poner marcador</button>
    <button class="back-btn" onclick="goBack()">‚Üê Biblioteca</button>
  </div>
</div>

<!-- STAGE -->
<div class="stage" id="stage" style="display:none">
  <div class="book-wrapper" id="bookWrapper">

    <button class="nav-btn nav-prev" id="prevBtn" onclick="prevPage()" disabled>‚Äπ</button>

    <div class="book" id="book">
      <div class="page-side page-left" id="pageLeft">
        <canvas id="canvasLeft"></canvas>
        <span class="page-num" id="numLeft"></span>
      </div>
      <div class="spine"></div>
      <div class="page-side page-right" id="pageRight">
        <canvas id="canvasRight"></canvas>
        <span class="page-num" id="numRight"></span>
      </div>

      <!-- Flip layers (added dynamically) -->
    </div>

    <button class="nav-btn nav-next" id="nextBtn" onclick="nextPage()">‚Ä∫</button>

  </div>
</div>

<!-- BOTTOM BAR -->
<div class="bottombar" id="bottombar" style="display:none">
  <span class="progress-label" id="pctLabel">0%</span>
  <div class="progress-wrap">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <span class="progress-label" id="totalLabel">‚Äî p√°gs</span>
</div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  let pdfDoc = null;
  let totalPages = 0;
  let currentSpread = 0;
  let pageWidth = 420;
  let pageHeight = 580;
  let isAnimating = false;

  // Leer libro desde localStorage (enviado por index.html)
  const libroActual = JSON.parse(localStorage.getItem('lorena_libro_actual') || 'null');
  const PDF_NAME = libroActual ? libroActual.pdf_url : 'annas-arch-60021976a045.pdf';

  // Intentar cargar el PDF autom√°ticamente al abrir
  window.addEventListener('load', async () => {
    // Actualizar t√≠tulo con el libro actual
    if (libroActual) {
      document.getElementById('bookTitle').textContent = libroActual.titulo;
    }
    try {
      const response = await fetch(PDF_NAME);
      if (response.ok) {
        const blob = await response.blob();
        const file = new File([blob], PDF_NAME, { type: 'application/pdf' });
        document.getElementById('uploadPrompt').classList.add('hidden');
        await startLoad(file);
        return;
      }
    } catch(e) { /* Si falla, muestra pantalla manual */ }
  });

  // Drag & drop on upload prompt
  const uploadPrompt = document.getElementById('uploadPrompt');
  uploadPrompt.addEventListener('dragover', e => { e.preventDefault(); });
  uploadPrompt.addEventListener('drop', e => {
    e.preventDefault();
    const file = e.dataTransfer.files[0];
    if (file && file.type === 'application/pdf') startLoad(file);
  });

  function loadPDF(event) {
    const file = event.target.files[0];
    if (file) startLoad(file);
  }

  async function startLoad(file) {
    uploadPrompt.classList.add('hidden');
    const loadScreen = document.getElementById('loadScreen');
    loadScreen.style.display = 'flex';

    const url = URL.createObjectURL(file);
    const titleEl = document.getElementById('bookTitle');
    titleEl.textContent = file.name.replace('.pdf','').replace(/-/g,' ');

    try {
      pdfDoc = await pdfjsLib.getDocument(url).promise;
      totalPages = pdfDoc.numPages;

      // Detect page size from first page
      const firstPage = await pdfDoc.getPage(1);
      const vp = firstPage.getViewport({ scale: 1 });
      const ratio = vp.height / vp.width;

      // Set responsive page size
      const maxH = Math.min(window.innerHeight - 120, 640);
      pageHeight = maxH;
      pageWidth = Math.round(pageHeight / ratio);
      // Cap width so two pages fit
      const maxW = Math.floor((window.innerWidth - 160) / 2);
      if (pageWidth > maxW) {
        pageWidth = maxW;
        pageHeight = Math.round(pageWidth * ratio);
      }

      applyPageSize();

      document.getElementById('totalLabel', ).textContent = `${totalPages} p√°gs`;
      document.getElementById('loadScreen').style.display = 'none';
      document.getElementById('topbar').style.display = 'flex';
      document.getElementById('stage').style.display = 'flex';
      document.getElementById('bottombar').style.display = 'flex';

      // Restaurar p√°gina donde qued√≥ la √∫ltima vez
      const savedPage = parseInt(localStorage.getItem('lorena_page_' + PDF_NAME)) || 0;
      const startSpread = (savedPage > 0 && savedPage < Math.ceil(totalPages / 2)) ? savedPage : 0;

      await renderSpread(startSpread, false);

      if (startSpread > 0) {
        showToast(`üìñ Continuando en la p√°gina ${startSpread * 2 + 1}`);
      }

      // Mostrar bot√≥n de marcador una vez cargado
      document.getElementById('bookmarkBtn').style.display = 'inline-flex';

    } catch(e) {
      alert('Error al cargar el PDF. Intenta de nuevo.');
      location.reload();
    }
  }

  function applyPageSize() {
    document.getElementById('pageLeft').style.width  = pageWidth + 'px';
    document.getElementById('pageLeft').style.height = pageHeight + 'px';
    document.getElementById('pageRight').style.width  = pageWidth + 'px';
    document.getElementById('pageRight').style.height = pageHeight + 'px';
  }

  async function renderPage(canvas, pageNum) {
    if (pageNum < 1 || pageNum > totalPages) {
      const ctx = canvas.getContext('2d');
      canvas.width = pageWidth * window.devicePixelRatio;
      canvas.height = pageHeight * window.devicePixelRatio;
      ctx.fillStyle = '#fdf8ee';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      return;
    }
    const page = await pdfDoc.getPage(pageNum);
    const scale = (pageWidth / page.getViewport({ scale: 1 }).width) * window.devicePixelRatio;
    const vp = page.getViewport({ scale });
    canvas.width = vp.width;
    canvas.height = vp.height;
    canvas.style.width = pageWidth + 'px';
    canvas.style.height = pageHeight + 'px';
    await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
  }

  async function renderSpread(spreadIndex, animate, direction) {
    const leftPageNum  = spreadIndex * 2 + 1;
    const rightPageNum = spreadIndex * 2 + 2;

    if (animate) {
      await animateFlip(spreadIndex, direction);
    } else {
      await Promise.all([
        renderPage(document.getElementById('canvasLeft'),  leftPageNum),
        renderPage(document.getElementById('canvasRight'), rightPageNum),
      ]);
    }

    currentSpread = spreadIndex;
    // Guardar p√°gina actual para cuando vuelva
    localStorage.setItem('lorena_page_' + PDF_NAME, spreadIndex);
    updateUI();
  }

  async function animateFlip(targetSpread, direction) {
    if (isAnimating) return;
    isAnimating = true;

    const book = document.getElementById('book');

    // Create flip container
    const flipEl = document.createElement('div');
    flipEl.className = `flip-container flip-${direction === 'forward' ? 'right' : 'left'}`;
    flipEl.style.cssText = `top:0; height:${pageHeight}px; width:${pageWidth}px; perspective:2000px;`;

    const flipPage = document.createElement('div');
    flipPage.className = 'flip-page';

    const flipCanvas = document.createElement('canvas');
    flipPage.appendChild(flipCanvas);
    flipEl.appendChild(flipPage);
    book.appendChild(flipEl);

    // Render the "turning" page face
    const turningPageNum = direction === 'forward'
      ? currentSpread * 2 + 2   // right page going away
      : targetSpread * 2 + 1;   // left page going away

    await renderPage(flipCanvas, turningPageNum);
    flipCanvas.style.width = pageWidth + 'px';
    flipCanvas.style.height = pageHeight + 'px';

    // Pre-render the target spread (hidden behind)
    const newLeftNum  = targetSpread * 2 + 1;
    const newRightNum = targetSpread * 2 + 2;

    await Promise.all([
      renderPage(document.getElementById('canvasLeft'),  newLeftNum),
      renderPage(document.getElementById('canvasRight'), newRightNum),
    ]);

    // Trigger animation
    flipEl.classList.add(direction === 'forward' ? 'animating-forward' : 'animating-back');

    await new Promise(r => setTimeout(r, 680));

    book.removeChild(flipEl);
    isAnimating = false;
  }

  function updateUI() {
    const leftNum  = currentSpread * 2 + 1;
    const rightNum = currentSpread * 2 + 2;

    document.getElementById('numLeft').textContent  = leftNum <= totalPages ? leftNum : '';
    document.getElementById('numRight').textContent = rightNum <= totalPages ? rightNum : '';

    document.getElementById('pageIndicator').textContent =
      rightNum <= totalPages
        ? `P√°ginas ${leftNum}‚Äì${rightNum} de ${totalPages}`
        : `P√°gina ${leftNum} de ${totalPages}`;

    const pct = Math.round((rightNum / totalPages) * 100);
    document.getElementById('progressBar').style.width = Math.min(pct, 100) + '%';
    document.getElementById('pctLabel').textContent = Math.min(pct, 100) + '%';

    document.getElementById('prevBtn').disabled = currentSpread === 0;
    document.getElementById('nextBtn').disabled = (currentSpread + 1) * 2 >= totalPages;
    updateBookmarkBtn();
  }

  async function nextPage() {
    if (isAnimating) return;
    const next = currentSpread + 1;
    if (next * 2 >= totalPages) return;
    await renderSpread(next, true, 'forward');
  }

  async function prevPage() {
    if (isAnimating) return;
    const prev = currentSpread - 1;
    if (prev < 0) return;
    await renderSpread(prev, true, 'back');
  }

  // Keyboard navigation
  document.addEventListener('keydown', e => {
    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') nextPage();
    if (e.key === 'ArrowLeft'  || e.key === 'ArrowUp')   prevPage();
  });

  function goBack() {
    window.location.href = 'index.html';
  }

  // ‚îÄ‚îÄ MARCADOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let bookmarkSpread = null;

  function handleBookmarkBtn() {
    const btn = document.getElementById('bookmarkBtn');
    if (bookmarkSpread === null) {
      // No hay marcador ‚Üí ponerlo aqu√≠
      placeBookmark();
    } else if (bookmarkSpread === currentSpread) {
      // Estamos EN el marcador ‚Üí preguntar si moverlo o quitarlo
      showBookmarkMenu();
    } else {
      // Hay marcador en otra p√°gina ‚Üí ir o moverlo
      showBookmarkMenu();
    }
  }

  function placeBookmark() {
    bookmarkSpread = currentSpread;
    const pageNum = currentSpread * 2 + 1;
    localStorage.setItem('lorena_bookmark_' + PDF_NAME, currentSpread);
    updateBookmarkBtn();
    showToast(`üéÄ Marcador puesto en la p√°gina ${pageNum}`);
  }

  function removeBookmark() {
    bookmarkSpread = null;
    localStorage.removeItem('lorena_bookmark_' + PDF_NAME);
    updateBookmarkBtn();
    closeBookmarkMenu();
    showToast(`üéÄ Marcador quitado`);
  }

  function goToBookmark() {
    closeBookmarkMenu();
    if (bookmarkSpread !== null && bookmarkSpread !== currentSpread) {
      const dir = bookmarkSpread > currentSpread ? 'forward' : 'back';
      renderSpread(bookmarkSpread, true, dir);
    }
  }

  function moveBookmarkHere() {
    closeBookmarkMenu();
    placeBookmark();
  }

  function showBookmarkMenu() {
    // Remove any existing menu
    closeBookmarkMenu();
    const pageNum = bookmarkSpread !== null ? bookmarkSpread * 2 + 1 : null;
    const isHere = bookmarkSpread === currentSpread;
    const menu = document.createElement('div');
    menu.id = 'bookmarkMenu';
    menu.style.cssText = `
      position:fixed; top:60px; right:16px; z-index:500;
      background:#1a0f14; border:1px solid rgba(212,120,154,0.3);
      border-radius:14px; padding:8px; min-width:200px;
      box-shadow:0 8px 32px rgba(0,0,0,0.5);
      backdrop-filter:blur(10px);
      animation:menuIn 0.2s ease;
    `;
    const style = document.createElement('style');
    style.textContent = `@keyframes menuIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}`;
    document.head.appendChild(style);

    const btnStyle = `display:block;width:100%;background:none;border:none;color:#f5ede0;font-family:'Cormorant Garamond',serif;font-size:0.95rem;padding:10px 14px;text-align:left;cursor:pointer;border-radius:8px;transition:background 0.15s;`;

    menu.innerHTML = `
      ${!isHere ? `<button style="${btnStyle}" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='none'" onclick="goToBookmark()">üìñ Ir a p√°g. ${pageNum}</button>` : ''}
      <button style="${btnStyle}" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='none'" onclick="moveBookmarkHere()">üéÄ Mover marcador aqu√≠</button>
      <button style="${btnStyle};color:rgba(212,120,154,0.8);" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='none'" onclick="removeBookmark()">‚úï Quitar marcador</button>
    `;
    document.body.appendChild(menu);
    // Close on outside click
    setTimeout(() => document.addEventListener('click', outsideMenuClick), 10);
  }

  function outsideMenuClick(e) {
    const menu = document.getElementById('bookmarkMenu');
    if (menu && !menu.contains(e.target) && e.target.id !== 'bookmarkBtn') {
      closeBookmarkMenu();
    }
  }

  function closeBookmarkMenu() {
    const menu = document.getElementById('bookmarkMenu');
    if (menu) menu.remove();
    document.removeEventListener('click', outsideMenuClick);
  }

  function updateBookmarkBtn() {
    const btn = document.getElementById('bookmarkBtn');
    if (!btn) return;
    if (bookmarkSpread === null) {
      btn.innerHTML = `üéÄ Poner marcador`;
      btn.style.background = 'none';
      btn.style.borderColor = 'rgba(201,116,138,0.4)';
    } else if (bookmarkSpread === currentSpread) {
      btn.innerHTML = `üéÄ Aqu√≠ est√° tu marcador`;
      btn.style.background = 'rgba(201,116,138,0.2)';
      btn.style.borderColor = 'rgba(212,120,154,0.5)';
    } else {
      const pageNum = bookmarkSpread * 2 + 1;
      btn.innerHTML = `üéÄ Marcador en p√°g. ${pageNum}`;
      btn.style.background = 'rgba(201,116,138,0.1)';
      btn.style.borderColor = 'rgba(201,116,138,0.35)';
    }
    btn.onclick = handleBookmarkBtn;
  }

  function showToast(msg) {
    let toast = document.getElementById('toastEl');
    if (!toast) {
      toast = document.createElement('div');
      toast.id = 'toastEl';
      toast.style.cssText = `
        position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%);
        background: rgba(160,67,90,0.92); color: white; padding: 10px 24px;
        border-radius: 24px; font-family: 'Cormorant Garamond', serif;
        font-size: 0.9rem; font-style: italic; z-index: 999;
        backdrop-filter: blur(8px); pointer-events: none;
        transition: opacity 0.4s ease; white-space: nowrap;
      `;
      document.body.appendChild(toast);
    }
    toast.textContent = msg;
    toast.style.opacity = '1';
    clearTimeout(toast._t);
    toast._t = setTimeout(() => toast.style.opacity = '0', 2500);
  }

  // Cargar marcador guardado al inicio
  window.addEventListener('load', () => {
    const saved = localStorage.getItem('lorena_bookmark_' + PDF_NAME);
    if (saved !== null) bookmarkSpread = parseInt(saved);
  });
</script>
</body>
</html>