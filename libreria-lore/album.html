<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>√Ålbum ‚Äî Rinc√≥n de Lorena</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
<style>
:root{--bg:#0d0810;--surface:#16101a;--surface2:#1e1525;--cream:#f5ede0;--muted:rgba(245,237,224,0.5);--rose:#d4789a;--deep-rose:#a0435a;--gold:#c9a84c;--soft-gold:rgba(201,168,76,0.12);--border:rgba(201,168,76,0.12);--border-rose:rgba(212,120,154,0.2);}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);font-family:'Cormorant Garamond',serif;color:var(--cream);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse 60% 50% at 80% 80%,rgba(160,67,90,0.1) 0%,transparent 70%);}
.topbar{position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:rgba(13,8,16,0.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);}
.topbar-logo{font-family:'Playfair Display',serif;font-style:italic;color:var(--gold);font-size:1rem;text-decoration:none;}
.topbar-nav{display:flex;gap:2px;overflow-x:auto;}
.nav-link{color:var(--muted);font-size:0.78rem;padding:6px 12px;border-radius:20px;text-decoration:none;transition:all 0.2s;border:1px solid transparent;white-space:nowrap;}
.nav-link:hover{color:var(--cream);}
.nav-link.active{color:var(--gold);border-color:rgba(201,168,76,0.25);background:var(--soft-gold);}
.page-body{position:relative;z-index:1;max-width:1000px;margin:0 auto;padding:40px 20px 80px;}
.page-header{margin-bottom:20px;display:flex;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;gap:16px;}
.page-header-text h1{font-family:'Playfair Display',serif;font-size:clamp(1.8rem,5vw,2.6rem);}
.page-header-text h1 em{color:var(--rose);font-style:italic;}
.page-header-text p{color:var(--muted);font-style:italic;margin-top:6px;}
.header-actions{display:flex;gap:8px;flex-wrap:wrap;}
.btn-action{background:none;border:1px solid var(--border);color:var(--muted);padding:8px 16px;border-radius:20px;font-family:'Cormorant Garamond',serif;font-size:0.82rem;cursor:pointer;transition:all 0.2s;white-space:nowrap;}
.btn-action:hover{color:var(--cream);border-color:rgba(201,168,76,0.3);}
.btn-action.primary{background:linear-gradient(135deg,var(--deep-rose),var(--rose));color:white;border-color:transparent;}
.btn-action.primary:hover{opacity:0.85;}

/* TIP BANNER */
.tip-banner{background:rgba(201,168,76,0.07);border:1px solid rgba(201,168,76,0.2);border-radius:14px;padding:12px 16px;margin-bottom:22px;display:flex;align-items:flex-start;gap:10px;font-size:0.82rem;color:var(--muted);font-style:italic;}
.tip-banner .tip-icon{flex-shrink:0;font-size:1rem;}
.tip-banner b{color:var(--gold);}
.tip-close{margin-left:auto;background:none;border:none;color:var(--muted);cursor:pointer;font-size:1rem;padding:0 0 0 8px;flex-shrink:0;}

/* UPLOAD */
.upload-zone{border:2px dashed rgba(201,168,76,0.25);border-radius:18px;padding:32px;text-align:center;cursor:pointer;transition:all 0.3s;margin-bottom:28px;background:rgba(201,168,76,0.02);}
.upload-zone:hover,.upload-zone.drag-over{border-color:var(--rose);background:rgba(212,120,154,0.05);}
.upload-zone .uz-icon{font-size:2.4rem;margin-bottom:10px;}
.upload-zone p{color:var(--muted);font-style:italic;font-size:0.95rem;}
.upload-zone span{color:var(--gold);font-size:0.78rem;}

/* GRID */
.photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;}
.photo-item{position:relative;border-radius:14px;overflow:hidden;cursor:pointer;aspect-ratio:1;background:var(--surface);transition:transform 0.25s;}
.photo-item:hover{transform:scale(1.02);}
.photo-item img{width:100%;height:100%;object-fit:cover;display:block;}
.photo-del{position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.65);color:white;border:none;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:0.75rem;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.2s;backdrop-filter:blur(4px);}
.photo-item:hover .photo-del{opacity:1;}
.photo-caption{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,0.7));padding:12px 10px 8px;font-size:0.78rem;color:rgba(255,255,255,0.85);font-style:italic;}

/* LIGHTBOX */
.lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:300;align-items:center;justify-content:center;padding:20px;}
.lightbox.active{display:flex;}
.lightbox-img{max-width:90vw;max-height:85vh;object-fit:contain;border-radius:8px;}
.lightbox-close{position:fixed;top:20px;right:24px;background:none;border:none;color:rgba(255,255,255,0.7);font-size:1.6rem;cursor:pointer;}
.lightbox-close:hover{color:white;}
.lightbox-nav{position:fixed;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:white;width:44px;height:44px;border-radius:50%;cursor:pointer;font-size:1.4rem;backdrop-filter:blur(4px);transition:background 0.2s;}
.lightbox-nav:hover{background:rgba(255,255,255,0.2);}
.lb-prev{left:16px;}.lb-next{right:16px;}
.lightbox-caption{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);color:rgba(255,255,255,0.6);font-style:italic;font-size:0.9rem;}

/* CAPTION MODAL */
.cap-overlay{display:none;position:fixed;inset:0;background:rgba(5,2,8,0.85);backdrop-filter:blur(10px);z-index:400;align-items:center;justify-content:center;padding:20px;}
.cap-overlay.active{display:flex;}
.cap-modal{background:var(--surface);border:1px solid var(--border-rose);border-radius:20px;padding:30px 26px;max-width:380px;width:100%;text-align:center;}
.cap-modal h3{font-family:'Playfair Display',serif;margin-bottom:16px;font-style:italic;}
.cap-modal input{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--cream);padding:12px 16px;border-radius:12px;font-family:'Cormorant Garamond',serif;font-size:1rem;outline:none;margin-bottom:14px;transition:border-color 0.2s;}
.cap-modal input:focus{border-color:var(--border-rose);}
.cap-modal input::placeholder{color:var(--muted);}
.cap-btns{display:flex;gap:10px;justify-content:center;}
.btn-confirm{background:linear-gradient(135deg,var(--deep-rose),var(--rose));color:white;border:none;padding:10px 24px;border-radius:20px;font-family:'Cormorant Garamond',serif;font-size:0.95rem;cursor:pointer;}
.btn-skip{background:none;border:1px solid var(--border);color:var(--muted);padding:10px 20px;border-radius:20px;font-family:'Cormorant Garamond',serif;font-size:0.95rem;cursor:pointer;}
.empty-state{text-align:center;padding:40px;color:var(--muted);}
.empty-state .icon{font-size:3rem;margin-bottom:14px;opacity:0.4;}
.photo-count{color:var(--muted);font-size:0.82rem;font-style:italic;}
@media(max-width:600px){.topbar-nav .nav-text{display:none;}.photo-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));}.header-actions{width:100%;}}
</style>
</head>
<body>
<header class="topbar">
  <a href="index.html" class="topbar-logo">Rinc√≥n de Lorena üåπ</a>
  <nav class="topbar-nav">
    <a href="biblioteca.html" class="nav-link">üìö<span class="nav-text"> Libros</span></a>
    <a href="videos.html" class="nav-link">üé¨<span class="nav-text"> Videos</span></a>
    <a href="musica.html" class="nav-link">üéµ<span class="nav-text"> M√∫sica</span></a>
    <a href="calendario.html" class="nav-link">üìÖ<span class="nav-text"> Agenda</span></a>
    <a href="diario.html" class="nav-link">üí≠<span class="nav-text"> Diario</span></a>
    <a href="album.html" class="nav-link active">üñºÔ∏è<span class="nav-text"> √Ålbum</span></a>
    <a href="wishlist.html" class="nav-link">‚ú®<span class="nav-text"> Wishlist</span></a>
    <a href="mood.html" class="nav-link">üåô<span class="nav-text"> Mood</span></a>
  </nav>
</header>

<div class="page-body">
  <div class="page-header">
    <div class="page-header-text">
      <h1>Tu <em>√Ålbum</em> üñºÔ∏è</h1>
      <p id="photoCount"></p>
    </div>
    <div class="header-actions">
      <button class="btn-action" onclick="exportBackup()" title="Guardar todas las fotos en un archivo de respaldo">üíæ Guardar respaldo</button>
      <button class="btn-action" onclick="document.getElementById('importInput').click()" title="Restaurar fotos desde un respaldo">üìÇ Restaurar respaldo</button>
      <input type="file" id="importInput" accept=".json" style="display:none" onchange="importBackup(event)">
      <button class="btn-action primary" onclick="document.getElementById('photoInput').click()">Ôºã Agregar fotos</button>
    </div>
  </div>

  <!-- TIP -->
  <div class="tip-banner" id="tipBanner">
    <span class="tip-icon">üí°</span>
    <span>Las fotos se suben autom√°ticamente a la nube con <b>ImgBB + Firebase</b> üåπ Estar√°n disponibles desde cualquier dispositivo.</span>
    <button class="tip-close" onclick="closeTip()">‚úï</button>
  </div>

  <!-- UPLOAD -->
  <div class="upload-zone" id="uploadZone" onclick="document.getElementById('photoInput').click()">
    <div class="uz-icon">üì∏</div>
    <p>Toca aqu√≠ para agregar fotos</p>
    <span>Desde tu celular o computador ‚Äî todas las que quieras</span>
  </div>
  <input type="file" id="photoInput" accept="image/*" multiple style="display:none" onchange="handleFiles(event)">

  <!-- GRID -->
  <div class="photo-grid" id="photoGrid"></div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox">
  <button class="lightbox-close" onclick="closeLB()">‚úï</button>
  <button class="lightbox-nav lb-prev" onclick="lbNav(-1)">‚Äπ</button>
  <img class="lightbox-img" id="lbImg" src="" alt="">
  <button class="lightbox-nav lb-next" onclick="lbNav(1)">‚Ä∫</button>
  <span class="lightbox-caption" id="lbCaption"></span>
</div>

<!-- CAPTION MODAL -->
<div class="cap-overlay" id="capOverlay">
  <div class="cap-modal">
    <h3>¬øAlg√∫n t√≠tulo para esta foto? üå∏</h3>
    <input type="text" id="capInput" placeholder="Ej: Mi momento favorito..." maxlength="60">
    <div class="cap-btns">
      <button class="btn-skip" onclick="savePhoto('')">Sin t√≠tulo</button>
      <button class="btn-confirm" onclick="savePhoto(document.getElementById('capInput').value)">Guardar ‚ú®</button>
    </div>
  </div>
</div>

<script type="module">
import { db } from './firebase-config.js';
import { ref, get, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const IMGBB_KEY = "3dec58925d383bab2caebdbb0e2f43e0";
let photos = [];
let pendingPhoto = null;
let lbIndex = 0;

window.closeTip = function() {
  document.getElementById('tipBanner').style.display = 'none';
}

async function loadPhotos() {
  try {
    const snap = await get(ref(db, 'album/photos'));
    photos = snap.exists() ? snap.val() : [];
  } catch { photos = []; }
  renderGrid();
}

async function savePhotos() {
  try { await set(ref(db, 'album/photos'), photos); } catch(e) { console.error('Error guardando:', e); }
}

async function uploadToImgBB(base64data) {
  // Quitar el prefijo "data:image/...;base64,"
  const base64 = base64data.split(',')[1];
  const formData = new FormData();
  formData.append('image', base64);
  const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
    method: 'POST',
    body: formData
  });
  const json = await res.json();
  if (json.success) return json.data.url;
  throw new Error('ImgBB error');
}

function renderGrid() {
  const grid = document.getElementById('photoGrid');
  const count = document.getElementById('photoCount');
  count.textContent = photos.length ? `${photos.length} foto${photos.length !== 1 ? 's' : ''} guardadas` : 'Tus fotos, solo para ti';
  if (!photos.length) {
    grid.innerHTML = '<div class="empty-state"><div class="icon">üì∑</div><p>A√∫n no hay fotos. ¬°Agrega tu primera!</p></div>';
    return;
  }
  grid.innerHTML = photos.map((p, i) => `
    <div class="photo-item" onclick="openLB(${i})">
      <img src="${p.src}" alt="${p.caption || ''}">
      ${p.caption ? `<div class="photo-caption">${p.caption}</div>` : ''}
      <button class="photo-del" onclick="event.stopPropagation();deletePhoto(${i})">‚úï</button>
    </div>`).join('');
}

function handleFiles(e) {
  const files = [...e.target.files];
  if (!files.length) return;
  processNext(files, 0);
  e.target.value = '';
}

window.processNext = function(files, i) {
  if (i >= files.length) return;
  const reader = new FileReader();
  reader.onload = ev => {
    pendingPhoto = { src: ev.target.result, caption: '', date: new Date().toISOString() };
    document.getElementById('capInput').value = '';
    document.getElementById('capOverlay').classList.add('active');
    document.getElementById('capInput').focus();
    window._pendingNext = () => window.processNext(files, i + 1);
  };
  reader.readAsDataURL(files[i]);
}

window.savePhoto = async function(caption) {
  if (!pendingPhoto) return;
  const btn = document.querySelector('.btn-confirm');
  if (btn) { btn.textContent = 'Subiendo... ‚è≥'; btn.disabled = true; }
  try {
    // Si es base64 (foto subida), subirla a ImgBB
    if (pendingPhoto.src.startsWith('data:')) {
      pendingPhoto.src = await uploadToImgBB(pendingPhoto.src);
    }
  } catch(e) {
    console.error('Error subiendo a ImgBB:', e);
    alert('Hubo un error subiendo la foto. Intenta de nuevo üå∏');
    if (btn) { btn.textContent = 'Guardar ‚ú®'; btn.disabled = false; }
    return;
  }
  pendingPhoto.caption = caption.trim();
  photos.unshift(pendingPhoto);
  await savePhotos();
  renderGrid();
  pendingPhoto = null;
  document.getElementById('capOverlay').classList.remove('active');
  if (btn) { btn.textContent = 'Guardar ‚ú®'; btn.disabled = false; }
  if (window._pendingNext) { window._pendingNext(); window._pendingNext = null; }
}

document.getElementById('capInput').addEventListener('keydown', e => { if (e.key === 'Enter') savePhoto(document.getElementById('capInput').value); });
window.deletePhoto = async function(i) { if (confirm('¬øEliminar esta foto?')) { photos.splice(i, 1); await savePhotos(); renderGrid(); } }

// LIGHTBOX
window.openLB = function(i) { lbIndex = i; updateLB(); document.getElementById('lightbox').classList.add('active'); }
window.closeLB = function() { document.getElementById('lightbox').classList.remove('active'); }
window.lbNav = function(d) { lbIndex = (lbIndex + d + photos.length) % photos.length; updateLB(); }
function updateLB() { document.getElementById('lbImg').src = photos[lbIndex].src; document.getElementById('lbCaption').textContent = photos[lbIndex].caption || ''; }
document.getElementById('lightbox').addEventListener('click', e => { if (e.target === document.getElementById('lightbox')) closeLB(); });
document.addEventListener('keydown', e => {
  if (!document.getElementById('lightbox').classList.contains('active')) return;
  if (e.key === 'ArrowLeft') lbNav(-1);
  if (e.key === 'ArrowRight') lbNav(1);
  if (e.key === 'Escape') closeLB();
});

// DRAG & DROP
const uz = document.getElementById('uploadZone');
uz.addEventListener('dragover', e => { e.preventDefault(); uz.classList.add('drag-over'); });
uz.addEventListener('dragleave', () => uz.classList.remove('drag-over'));
uz.addEventListener('drop', e => {
  e.preventDefault(); uz.classList.remove('drag-over');
  const files = [...e.dataTransfer.files].filter(f => f.type.startsWith('image/'));
  if (files.length) processNext(files, 0);
});

// EXPORT BACKUP
function exportBackup() {
  if (!photos.length) { alert('No hay fotos para guardar todav√≠a üå∏'); return; }
  const data = JSON.stringify({ version: 1, exported: new Date().toISOString(), photos });
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `album-lorena-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

// IMPORT BACKUP
function importBackup(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      const incoming = data.photos || [];
      if (!incoming.length) { alert('El archivo no tiene fotos.'); return; }
      if (confirm(`¬øRestaurar ${incoming.length} foto(s) del respaldo?\n\nEsto se sumar√° a tus fotos actuales.`)) {
        // Merge without duplicates by src
        const existingSrcs = new Set(photos.map(p => p.src.slice(0, 50)));
        const newPhotos = incoming.filter(p => !existingSrcs.has(p.src.slice(0, 50)));
        photos = [...newPhotos, ...photos];
        savePhotosLS();
        renderGrid();
        alert(`‚ú® Se restauraron ${newPhotos.length} foto(s).`);
      }
    } catch { alert('No se pudo leer el archivo de respaldo.'); }
  };
  reader.readAsText(file);
  e.target.value = '';
}

loadPhotos();
</script>
</body>
</html>