<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>√Ålbum ‚Äî Rinc√≥n de Lorena</title>
<link rel="stylesheet" href="lore.css">
<style>
:root{
  --bg:#06040c;--surface:#110e1a;--surface2:#181425;--surface3:#201b30;
  --cream:#f0e6d3;--muted:rgba(240,230,211,0.42);--muted2:rgba(240,230,211,0.22);
  --rose:#c8607f;--rose2:#e07898;--deep-rose:#8a3050;
  --gold:#b8942a;--gold2:#d4ae4a;
  --soft-gold:rgba(184,148,42,0.08);--border:rgba(184,148,42,0.12);--border-rose:rgba(200,96,127,0.16);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);font-family:'Cormorant Garamond',serif;color:var(--cream);min-height:100vh;overflow-x:hidden;}

.topbar{position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:rgba(13,8,16,0.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);}
.topbar-logo{font-family:'Playfair Display',serif;font-style:italic;color:var(--gold);font-size:1rem;text-decoration:none;}
.topbar-nav{display:flex;gap:2px;overflow-x:auto;}
.nav-link{color:var(--muted);font-size:0.78rem;padding:6px 12px;border-radius:20px;text-decoration:none;transition:all 0.2s;border:1px solid transparent;white-space:nowrap;}
.nav-link:hover{color:var(--cream);}
.nav-link.active{color:var(--gold);border-color:rgba(201,168,76,0.25);background:var(--soft-gold);}
.page-body{position:relative;z-index:1;max-width:1000px;margin:0 auto;padding:40px 20px 80px;}
.page-header{margin-bottom:24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;}
.page-header h1{font-family:'Playfair Display',serif;font-size:clamp(1.8rem,5vw,2.6rem);}
.page-header h1 em{color:var(--rose);font-style:italic;}

/* LOADING */
.loading-bar{text-align:center;padding:60px 20px;color:var(--muted);font-style:italic;}
.loading-bar .spin{font-size:2rem;display:block;margin-bottom:12px;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* UPLOAD */
.upload-zone{border:2px dashed rgba(201,168,76,0.2);border-radius:18px;padding:28px;text-align:center;cursor:pointer;transition:all 0.3s;margin-bottom:24px;background:rgba(201,168,76,0.02);}
.upload-zone:hover,.upload-zone.drag-over{border-color:var(--rose);background:rgba(212,120,154,0.04);}
.upload-zone .uz-icon{font-size:2rem;margin-bottom:8px;}
.upload-zone p{color:var(--muted);font-style:italic;font-size:0.9rem;}
.upload-zone span{color:var(--gold);font-size:0.75rem;}

/* ALBUMS TABS */
.albums-bar{display:flex;align-items:center;gap:8px;margin-bottom:24px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none;}
.albums-bar::-webkit-scrollbar{display:none;}
.album-tab{background:var(--surface);border:1px solid var(--border);color:var(--muted);padding:8px 18px;border-radius:22px;font-family:'Cormorant Garamond',serif;font-size:0.85rem;cursor:pointer;transition:all 0.2s;white-space:nowrap;flex-shrink:0;}
.album-tab:hover{color:var(--cream);}
.album-tab.active{background:var(--soft-gold);border-color:rgba(201,168,76,0.35);color:var(--gold);}
.album-tab .cnt{font-size:0.7rem;opacity:0.6;margin-left:3px;}
.btn-new-album{background:none;border:1px dashed rgba(201,168,76,0.3);color:var(--muted);padding:8px 14px;border-radius:22px;font-family:'Cormorant Garamond',serif;font-size:0.82rem;cursor:pointer;transition:all 0.2s;white-space:nowrap;flex-shrink:0;}
.btn-new-album:hover{border-color:var(--gold);color:var(--gold);}

/* PHOTO GRID */
.photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:12px;}
.photo-item{position:relative;border-radius:12px;overflow:hidden;cursor:pointer;aspect-ratio:1;background:var(--surface);transition:transform 0.25s;}
.photo-item:hover{transform:scale(1.02);}
.photo-item img{width:100%;height:100%;object-fit:cover;display:block;}
.photo-del{position:absolute;top:7px;right:7px;background:rgba(0,0,0,0.65);color:white;border:none;width:26px;height:26px;border-radius:50%;cursor:pointer;font-size:0.7rem;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.2s;backdrop-filter:blur(4px);}
.photo-item:hover .photo-del{opacity:1;}
.photo-caption{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,0.7));padding:12px 10px 7px;font-size:0.75rem;color:rgba(255,255,255,0.85);font-style:italic;}
.empty-state{text-align:center;padding:50px 20px;color:var(--muted);grid-column:1/-1;}
.empty-state .icon{font-size:2.8rem;margin-bottom:12px;opacity:0.4;}

/* UPLOAD STATUS */
.upload-status{display:none;position:fixed;bottom:24px;right:24px;background:var(--surface);border:1px solid var(--border-rose);border-radius:14px;padding:14px 18px;z-index:500;font-size:0.88rem;color:var(--cream);box-shadow:0 8px 32px rgba(0,0,0,0.5);}
.upload-status.visible{display:flex;align-items:center;gap:10px;}

/* LIGHTBOX */
.lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.96);z-index:300;align-items:center;justify-content:center;padding:20px;}
.lightbox.active{display:flex;}
.lightbox-img{max-width:90vw;max-height:85vh;object-fit:contain;border-radius:6px;}
.lightbox-close{position:fixed;top:18px;right:22px;background:none;border:none;color:rgba(255,255,255,0.6);font-size:1.5rem;cursor:pointer;}
.lightbox-close:hover{color:white;}
.lightbox-nav{position:fixed;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.08);border:none;color:white;width:42px;height:42px;border-radius:50%;cursor:pointer;font-size:1.3rem;backdrop-filter:blur(4px);transition:background 0.2s;display:flex;align-items:center;justify-content:center;}
.lightbox-nav:hover{background:rgba(255,255,255,0.18);}
.lb-prev{left:14px;}.lb-next{right:14px;}
.lightbox-caption{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);color:rgba(255,255,255,0.55);font-style:italic;font-size:0.88rem;}

/* CAPTION MODAL */
.cap-overlay{display:none;position:fixed;inset:0;background:rgba(5,2,8,0.85);backdrop-filter:blur(10px);z-index:400;align-items:center;justify-content:center;padding:20px;}
.cap-overlay.active{display:flex;}
.cap-modal{background:var(--surface);border:1px solid var(--border-rose);border-radius:20px;padding:28px 24px;max-width:400px;width:100%;}
.cap-modal h3{font-family:'Playfair Display',serif;margin-bottom:16px;font-style:italic;font-size:1.1rem;}
.cap-preview{width:100%;height:140px;object-fit:cover;border-radius:10px;margin-bottom:14px;display:block;}
.cap-modal input,.cap-modal select{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--cream);padding:11px 14px;border-radius:12px;font-family:'Cormorant Garamond',serif;font-size:0.95rem;outline:none;margin-bottom:12px;}
.cap-modal input::placeholder{color:var(--muted);}
.cap-modal input:focus,.cap-modal select:focus{border-color:var(--border-rose);}
.cap-modal select option{background:var(--surface2);}
.cap-btns{display:flex;gap:10px;justify-content:flex-end;margin-top:4px;}
.btn-confirm{background:linear-gradient(135deg,var(--deep-rose),var(--rose));color:white;border:none;padding:10px 22px;border-radius:20px;font-family:'Cormorant Garamond',serif;font-size:0.92rem;cursor:pointer;}
.btn-confirm:disabled{opacity:0.5;cursor:not-allowed;}
.btn-skip{background:none;border:1px solid var(--border);color:var(--muted);padding:10px 18px;border-radius:20px;font-family:'Cormorant Garamond',serif;font-size:0.92rem;cursor:pointer;}

/* NEW ALBUM MODAL */
.album-modal{background:var(--surface);border:1px solid var(--border-rose);border-radius:20px;padding:28px 24px;max-width:380px;width:100%;}
.album-modal h3{font-family:'Playfair Display',serif;margin-bottom:16px;font-style:italic;font-size:1.1rem;}
.album-modal input{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--cream);padding:11px 14px;border-radius:12px;font-family:'Cormorant Garamond',serif;font-size:0.95rem;outline:none;margin-bottom:12px;}
.album-modal input::placeholder{color:var(--muted);}
.album-modal input:focus{border-color:var(--border-rose);}

@media(max-width:600px){.topbar-nav .nav-text{display:none;}.photo-grid{grid-template-columns:repeat(auto-fill,minmax(130px,1fr));}}

body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse 80% 55% at -5% 0%,rgba(138,48,80,0.2) 0%,transparent 55%),
  radial-gradient(ellipse 55% 45% at 105% 105%,rgba(184,148,42,0.09) 0%,transparent 55%);}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;opacity:0.4;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");}
.page-body{animation:pgIn 0.45s ease;}@keyframes pgIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
::-webkit-scrollbar{width:3px;height:3px;}::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(184,148,42,0.2);border-radius:3px;}
.topbar{background:rgba(6,4,12,0.92)!important;backdrop-filter:blur(28px) saturate(1.4)!important;}
.topbar::after{content:'';position:absolute;bottom:0;left:5%;right:5%;height:1px;background:linear-gradient(90deg,transparent,rgba(184,148,42,0.12),transparent);}
.page-header h1 em{background:linear-gradient(135deg,#e07898,#f09ab8)!important;-webkit-background-clip:text!important;-webkit-text-fill-color:transparent!important;background-clip:text!important;}
.btn-save,.btn-add,.btn-action.primary,.btn-unlock{transition:all 0.25s!important;}
.btn-save:hover,.btn-add:hover,.btn-action.primary:hover{transform:translateY(-2px)!important;box-shadow:0 8px 28px rgba(138,48,80,0.4)!important;}
input:focus,textarea:focus{box-shadow:0 0 0 3px rgba(200,96,127,0.07)!important;}
.song-card,.book-card,.video-card,.entry-card,.event-item,.carta-item,.grid-card,.photo-item{transition:all 0.25s!important;}

</style>
</head>
<body>
<header class="topbar">
  <a href="index.html" class="topbar-logo">Rinc√≥n de Lorena üåπ</a>
  <nav class="topbar-nav">
    <a href="biblioteca.html" class="nav-link">üìö<span class="nav-text"> Libros</span></a>
    <a href="videos.html" class="nav-link">üé¨<span class="nav-text"> Videos</span></a>
    <a href="musica.html" class="nav-link">üéµ<span class="nav-text"> M√∫sica</span></a>
    <a href="calendario.html" class="nav-link">üìÖ<span class="nav-text"> Agenda</span></a>
    <a href="diario.html" class="nav-link">üí≠<span class="nav-text"> Diario</span></a>
    <a href="album.html" class="nav-link active">üñºÔ∏è<span class="nav-text"> √Ålbum</span></a>
    <a href="wishlist.html" class="nav-link">‚ú®<span class="nav-text"> Wishlist</span></a>
    <a href="mood.html" class="nav-link">üåô<span class="nav-text"> Mood</span></a>
  </nav>
</header>

<div class="page-body">
  <div class="page-header">
    <h1>Tu <em>√Ålbum</em> üñºÔ∏è</h1>
  </div>
  <div class="albums-bar" id="albumsBar"></div>
  <div class="upload-zone" id="uploadZone" onclick="document.getElementById('photoInput').click()">
    <div class="uz-icon">üì∏</div>
    <p>Toca aqu√≠ para agregar fotos</p>
    <span>Desde tu celular o computador</span>
  </div>
  <input type="file" id="photoInput" accept="image/*" multiple style="display:none" onchange="handleFiles(event)">
  <div class="photo-grid" id="photoGrid">
    <div class="loading-bar"><span class="spin">üå∏</span>Cargando fotos...</div>
  </div>
</div>

<!-- UPLOAD STATUS -->
<div class="upload-status" id="uploadStatus">
  <span>üì§</span><span id="uploadStatusText">Subiendo foto...</span>
</div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox">
  <button class="lightbox-close" onclick="closeLB()">‚úï</button>
  <button class="lightbox-nav lb-prev" onclick="lbNav(-1)">‚Äπ</button>
  <img class="lightbox-img" id="lbImg" src="" alt="">
  <button class="lightbox-nav lb-next" onclick="lbNav(1)">‚Ä∫</button>
  <span class="lightbox-caption" id="lbCaption"></span>
</div>

<!-- CAPTION MODAL -->
<div class="cap-overlay" id="capOverlay">
  <div class="cap-modal">
    <h3>¬øT√≠tulo para esta foto? üå∏</h3>
    <img class="cap-preview" id="capPreview" src="" alt="">
    <input type="text" id="capInput" placeholder="Ej: Mi momento favorito..." maxlength="60">
    <select id="capAlbum"></select>
    <div class="cap-btns">
      <button class="btn-skip" id="btnSkip" onclick="savePhoto('')">Sin t√≠tulo</button>
      <button class="btn-confirm" id="btnConfirm" onclick="savePhoto(document.getElementById('capInput').value)">Guardar ‚ú®</button>
    </div>
  </div>
</div>

<!-- NEW ALBUM MODAL -->
<div class="cap-overlay" id="albumOverlay">
  <div class="album-modal">
    <h3>Nuevo √°lbum üìÅ</h3>
    <input type="text" id="albumNameInput" placeholder="Nombre del √°lbum..." maxlength="30">
    <div class="cap-btns">
      <button class="btn-skip" onclick="closeAlbumModal()">Cancelar</button>
      <button class="btn-confirm" onclick="createAlbum()">Crear ‚ú®</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyA2YJXgAZAjOVqZ3eeTiMa9kCKaut_cA2w",
  authDomain: "lore-basedatos.firebaseapp.com",
  databaseURL: "https://lore-basedatos-default-rtdb.firebaseio.com",
  projectId: "lore-basedatos",
  storageBucket: "lore-basedatos.firebasestorage.app",
  messagingSenderId: "348470598297",
  appId: "1:348470598297:web:4634471f293f24a64fb608"
};
const IMGBB_KEY = "3dec58925d383bab2caebdbb0e2f43e0";
const DEFAULT_ALBUMS = ['Favoritas', 'Nosotros'];

const app = initializeApp(FIREBASE_CONFIG);
const db = getDatabase(app);

// STATE
let photos = [];
let albums = [];
let currentAlbum = 'Todas';
let pendingFiles = [];
let pendingIndex = 0;
let pendingPhoto = null;
let lbPhotos = [];
let lbIndex = 0;

// ‚îÄ‚îÄ FIREBASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadData() {
  try {
    const snap = await get(ref(db, 'album'));
    const val = snap.val();
    photos = val && val.photos ? val.photos : [];
    albums = val && val.albums ? val.albums : [...DEFAULT_ALBUMS];
  } catch(e) {
    console.error('Error cargando datos:', e);
    photos = [];
    albums = [...DEFAULT_ALBUMS];
  }
}

async function saveData() {
  try {
    await set(ref(db, 'album'), { photos, albums });
  } catch(e) {
    console.error('Error guardando datos:', e);
    showStatus('‚ùå Error guardando. Intenta de nuevo.');
    setTimeout(hideStatus, 3000);
  }
}

// ‚îÄ‚îÄ IMGBB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function uploadToImgBB(base64data) {
  // Remove the data:image/...;base64, prefix
  const base64 = base64data.indexOf(',') !== -1 ? base64data.split(',')[1] : base64data;
  const formData = new FormData();
  formData.append('image', base64);
  const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
    method: 'POST',
    body: formData
  });
  const result = await response.json();
  if (result.success) return result.data.url;
  throw new Error('ImgBB error: ' + JSON.stringify(result));
}

// ‚îÄ‚îÄ STATUS TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showStatus(msg) {
  document.getElementById('uploadStatusText').textContent = msg;
  document.getElementById('uploadStatus').classList.add('visible');
}
function hideStatus() {
  document.getElementById('uploadStatus').classList.remove('visible');
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAlbumsBar() {
  const bar = document.getElementById('albumsBar');
  const allAlbums = ['Todas', ...albums];
  bar.innerHTML = allAlbums.map(a => {
    const cnt = a === 'Todas' ? photos.length : photos.filter(p => p.album === a).length;
    return `<button class="album-tab${currentAlbum === a ? ' active' : ''}" onclick="selectAlbum('${a}')">${a} <span class="cnt">${cnt}</span></button>`;
  }).join('') + `<button class="btn-new-album" onclick="openAlbumModal()">Ôºã √Ålbum</button>`;
}

function renderGrid() {
  const grid = document.getElementById('photoGrid');
  const filtered = currentAlbum === 'Todas' ? photos : photos.filter(p => p.album === currentAlbum);
  lbPhotos = filtered;
  if (!filtered.length) {
    grid.innerHTML = `<div class="empty-state"><div class="icon">üì∑</div><p>${currentAlbum === 'Todas' ? '¬°Agrega tu primera foto!' : 'Este √°lbum est√° vac√≠o.'}</p></div>`;
    return;
  }
  grid.innerHTML = filtered.map((p, i) => `
    <div class="photo-item" onclick="openLB(${i})">
      <img src="${p.src}" alt="${p.caption || ''}" loading="lazy" onerror="this.parentElement.style.opacity='0.4'">
      ${p.caption ? `<div class="photo-caption">${p.caption}</div>` : ''}
      <button class="photo-del" onclick="event.stopPropagation();deletePhoto('${p.id}')">‚úï</button>
    </div>`).join('');
}

window.selectAlbum = function(name) {
  currentAlbum = name;
  renderAlbumsBar();
  renderGrid();
};

// ‚îÄ‚îÄ UPLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.handleFiles = function(e) {
  const files = [...e.target.files].filter(f => f.type.startsWith('image/'));
  if (!files.length) return;
  e.target.value = '';
  pendingFiles = files;
  pendingIndex = 0;
  processNextFile();
};

function processNextFile() {
  if (pendingIndex >= pendingFiles.length) return;
  const file = pendingFiles[pendingIndex];
  const reader = new FileReader();
  reader.onload = function(ev) {
    const base64 = ev.target.result;
    pendingPhoto = {
      id: Date.now() + '_' + pendingIndex,
      srcBase64: base64,
      src: base64, // preview
      caption: '',
      album: currentAlbum === 'Todas' ? albums[0] || 'Fotos' : currentAlbum,
      date: new Date().toISOString()
    };
    // Show preview in modal
    document.getElementById('capPreview').src = base64;
    const sel = document.getElementById('capAlbum');
    sel.innerHTML = albums.map(a => `<option value="${a}"${pendingPhoto.album === a ? ' selected' : ''}>${a}</option>`).join('');
    document.getElementById('capInput').value = '';
    document.getElementById('btnConfirm').disabled = false;
    document.getElementById('btnSkip').disabled = false;
    document.getElementById('capOverlay').classList.add('active');
    document.getElementById('capInput').focus();
  };
  reader.readAsDataURL(file);
}

window.savePhoto = async function(caption) {
  if (!pendingPhoto) return;

  // Disable buttons while uploading
  document.getElementById('btnConfirm').disabled = true;
  document.getElementById('btnSkip').disabled = true;
  document.getElementById('capOverlay').classList.remove('active');

  const photo = pendingPhoto;
  photo.caption = caption.trim();
  photo.album = document.getElementById('capAlbum').value || albums[0] || 'Fotos';
  pendingPhoto = null;

  showStatus(`üì§ Subiendo foto ${pendingIndex + 1} de ${pendingFiles.length}...`);

  try {
    const url = await uploadToImgBB(photo.srcBase64);
    photo.src = url;
    delete photo.srcBase64;
    showStatus('üíæ Guardando...');
    photos.unshift(photo);
    await saveData();
    renderAlbumsBar();
    renderGrid();
    showStatus('‚úÖ ¬°Foto guardada!');
    setTimeout(hideStatus, 2000);
  } catch(e) {
    console.error('Error subiendo foto:', e);
    showStatus('‚ùå Error al subir. Intenta de nuevo.');
    setTimeout(hideStatus, 4000);
  }

  pendingIndex++;
  if (pendingIndex < pendingFiles.length) {
    setTimeout(processNextFile, 500);
  }
};

window.deletePhoto = async function(id) {
  if (!confirm('¬øEliminar esta foto?')) return;
  photos = photos.filter(p => String(p.id) !== String(id));
  await saveData();
  renderAlbumsBar();
  renderGrid();
};

// ‚îÄ‚îÄ ALBUM MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.openAlbumModal = function() {
  document.getElementById('albumNameInput').value = '';
  document.getElementById('albumOverlay').classList.add('active');
  setTimeout(() => document.getElementById('albumNameInput').focus(), 100);
};
window.closeAlbumModal = function() {
  document.getElementById('albumOverlay').classList.remove('active');
};
window.createAlbum = async function() {
  const name = document.getElementById('albumNameInput').value.trim();
  if (!name) return;
  if (!albums.includes(name)) {
    albums.push(name);
    await saveData();
  }
  closeAlbumModal();
  selectAlbum(name);
};
document.getElementById('albumNameInput').addEventListener('keydown', e => { if (e.key === 'Enter') createAlbum(); });

// ‚îÄ‚îÄ LIGHTBOX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.openLB = function(i) { lbIndex = i; updateLB(); document.getElementById('lightbox').classList.add('active'); };
window.closeLB = function() { document.getElementById('lightbox').classList.remove('active'); };
window.lbNav = function(d) { lbIndex = (lbIndex + d + lbPhotos.length) % lbPhotos.length; updateLB(); };
function updateLB() {
  document.getElementById('lbImg').src = lbPhotos[lbIndex].src;
  document.getElementById('lbCaption').textContent = lbPhotos[lbIndex].caption || '';
}
document.getElementById('lightbox').addEventListener('click', e => { if (e.target === document.getElementById('lightbox')) closeLB(); });
document.addEventListener('keydown', e => {
  if (!document.getElementById('lightbox').classList.contains('active')) return;
  if (e.key === 'ArrowLeft') lbNav(-1);
  if (e.key === 'ArrowRight') lbNav(1);
  if (e.key === 'Escape') closeLB();
});

// ‚îÄ‚îÄ DRAG & DROP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const uz = document.getElementById('uploadZone');
uz.addEventListener('dragover', e => { e.preventDefault(); uz.classList.add('drag-over'); });
uz.addEventListener('dragleave', () => uz.classList.remove('drag-over'));
uz.addEventListener('drop', e => {
  e.preventDefault();
  uz.classList.remove('drag-over');
  const files = [...e.dataTransfer.files].filter(f => f.type.startsWith('image/'));
  if (files.length) { pendingFiles = files; pendingIndex = 0; processNextFile(); }
});

document.getElementById('capInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') savePhoto(document.getElementById('capInput').value);
});

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async () => {
  await loadData();
  renderAlbumsBar();
  renderGrid();
})();
</script>
</body>
</html>