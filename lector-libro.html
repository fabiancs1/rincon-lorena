<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Lector â€” RincÃ³n de Lorena</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
:root {
  --bg:#0d0810; --surface:#16101a; --cream:#f5ede0; --muted:rgba(245,237,224,0.5);
  --rose:#d4789a; --deep-rose:#a0435a; --gold:#c9a84c;
  --border:rgba(201,168,76,0.15); --border-rose:rgba(212,120,154,0.25);
  --page-bg:#fdf8ee;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { background:var(--bg); font-family:'Cormorant Garamond',serif; color:var(--cream); height:100vh; overflow:hidden; display:flex; flex-direction:column; }

/* â”€â”€ TOPBAR â”€â”€ */
.topbar { display:flex; align-items:center; justify-content:space-between; padding:11px 18px; background:rgba(13,8,16,0.95); border-bottom:1px solid var(--border); backdrop-filter:blur(16px); flex-shrink:0; z-index:50; gap:8px; }
.topbar-left { display:flex; flex-direction:column; min-width:0; }
.book-title { font-family:'Playfair Display',serif; font-size:0.88rem; color:var(--gold); font-style:italic; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px; }
.book-author { font-size:0.68rem; color:var(--muted); margin-top:1px; }
.topbar-right { display:flex; align-items:center; gap:6px; flex-shrink:0; }
.tb-btn { background:none; border:1px solid var(--border); color:var(--muted); padding:6px 12px; border-radius:20px; font-family:'Cormorant Garamond',serif; font-size:0.78rem; cursor:pointer; transition:all 0.2s; white-space:nowrap; }
.tb-btn:hover { color:var(--cream); border-color:rgba(255,255,255,0.2); }
.tb-btn.bookmark-active { color:var(--rose); border-color:var(--border-rose); background:rgba(212,120,154,0.1); }
.page-ind { font-size:0.72rem; color:var(--muted); font-style:italic; white-space:nowrap; }

/* â”€â”€ STAGE â”€â”€ */
.stage { flex:1; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE MODE â€” single page swipe
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mobile-reader { width:100%; height:100%; display:none; flex-direction:column; position:relative; overflow:hidden; touch-action:pan-y; }
.mobile-reader.active { display:flex; }

.mobile-pages { flex:1; position:relative; overflow:hidden; }
.m-page { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:8px; will-change:transform; }
.m-page canvas { max-width:100%; max-height:100%; object-fit:contain; border-radius:4px; box-shadow:0 8px 32px rgba(0,0,0,0.5); background:var(--page-bg); }

/* Mobile tap zones */
.tap-zone { position:absolute; top:0; bottom:0; width:35%; z-index:10; cursor:pointer; display:flex; align-items:center; }
.tap-left  { left:0; justify-content:flex-start; padding-left:10px; }
.tap-right { right:0; justify-content:flex-end; padding-right:10px; }
.tap-arrow { background:rgba(0,0,0,0.35); color:rgba(255,255,255,0.6); width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.2rem; opacity:0; transition:opacity 0.2s; backdrop-filter:blur(4px); }
.tap-zone:hover .tap-arrow { opacity:1; }
.tap-zone:active .tap-arrow { opacity:1; background:rgba(212,120,154,0.5); }

/* Mobile bottom bar */
.mobile-bottom { display:flex; align-items:center; gap:12px; padding:10px 16px; background:rgba(13,8,16,0.9); border-top:1px solid var(--border); flex-shrink:0; }
.mob-progress-wrap { flex:1; height:3px; background:rgba(255,255,255,0.08); border-radius:2px; overflow:hidden; }
.mob-progress-bar  { height:100%; background:linear-gradient(to right,var(--deep-rose),var(--gold)); border-radius:2px; transition:width 0.3s ease; width:0%; }
.mob-page-label { font-size:0.7rem; color:var(--muted); font-style:italic; white-space:nowrap; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESKTOP MODE â€” two pages flip
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.desktop-reader { display:none; align-items:center; justify-content:center; width:100%; height:100%; gap:0; }
.desktop-reader.active { display:flex; }

.book-wrap { position:relative; display:flex; filter:drop-shadow(0 30px 60px rgba(0,0,0,0.7)); }
.book { display:flex; }
.page-side { background:var(--page-bg); overflow:hidden; position:relative; flex-shrink:0; }
.page-left  { border-radius:4px 0 0 4px; box-shadow:inset -4px 0 10px rgba(0,0,0,0.08); }
.page-right { border-radius:0 4px 4px 0; box-shadow:inset 4px 0 10px rgba(0,0,0,0.08); }
.spine { width:14px; background:linear-gradient(to right,#c8a87a,#e8d4a8,#c8a87a); flex-shrink:0; box-shadow:0 0 8px rgba(0,0,0,0.3); }
.page-side canvas { display:block; }
.page-side::after { content:''; position:absolute; inset:0; pointer-events:none; background:repeating-linear-gradient(0deg,transparent,transparent 28px,rgba(180,150,100,0.04) 28px,rgba(180,150,100,0.04) 29px); z-index:3; }
.page-num { position:absolute; bottom:10px; font-size:0.68rem; color:#9a7a60; opacity:0.6; z-index:4; }
.page-left .page-num  { right:16px; }
.page-right .page-num { left:16px; }

/* Flip animation */
.flip-container { position:absolute; top:0; pointer-events:none; z-index:10; perspective:2000px; }
.flip-container.flip-right { left:50%; transform-origin:left center; }
.flip-container.flip-left  { left:0;   transform-origin:right center; }
.flip-page { width:100%; height:100%; position:absolute; top:0; left:0; transform-style:preserve-3d; transform-origin:inherit; background:var(--page-bg); backface-visibility:hidden; }
.flip-page canvas { width:100%; height:100%; display:block; }
@keyframes flipFwd { 0%{transform:rotateY(0deg);box-shadow:4px 0 20px rgba(0,0,0,0.3)} 40%{box-shadow:-20px 0 40px rgba(0,0,0,0.4)} 100%{transform:rotateY(-180deg);box-shadow:4px 0 5px rgba(0,0,0,0.1)} }
@keyframes flipBck { 0%{transform:rotateY(0deg)} 100%{transform:rotateY(180deg)} }
.flip-container.animating-forward .flip-page { animation:flipFwd 0.65s cubic-bezier(0.645,0.045,0.355,1) forwards; }
.flip-container.animating-back    .flip-page { animation:flipBck 0.65s cubic-bezier(0.645,0.045,0.355,1) forwards; }

/* Desktop nav arrows */
.desk-nav { position:absolute; top:50%; transform:translateY(-50%); background:rgba(201,168,76,0.1); border:1px solid rgba(201,168,76,0.25); color:var(--gold); width:42px; height:42px; border-radius:50%; font-size:1.2rem; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s; z-index:20; backdrop-filter:blur(4px); }
.desk-nav:hover { background:rgba(201,168,76,0.22); transform:translateY(-50%) scale(1.08); }
.desk-nav:disabled { opacity:0.2; cursor:default; }
.desk-nav:disabled:hover { transform:translateY(-50%) scale(1); }
.desk-prev { left:-54px; } .desk-next { right:-54px; }

/* Desktop bottom bar */
.desktop-bottom { display:none; align-items:center; gap:16px; padding:11px 24px; background:rgba(13,8,16,0.8); border-top:1px solid var(--border); flex-shrink:0; }
.desktop-bottom.active { display:flex; }
.desk-progress-wrap { flex:1; max-width:400px; height:3px; background:rgba(255,255,255,0.08); border-radius:2px; overflow:hidden; }
.desk-progress-bar  { height:100%; background:linear-gradient(to right,var(--deep-rose),var(--gold)); border-radius:2px; transition:width 0.4s ease; width:0%; }
.desk-page-label { font-size:0.72rem; color:var(--muted); font-style:italic; }
.desk-pct { font-size:0.72rem; color:var(--muted); font-style:italic; }

/* â”€â”€ UPLOAD SCREEN â”€â”€ */
#uploadPrompt { position:fixed; inset:0; background:var(--bg); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:999; gap:20px; padding:30px; }
#uploadPrompt.hidden { display:none; }
.upload-box { border:2px dashed rgba(201,168,76,0.3); border-radius:20px; padding:50px 40px; text-align:center; cursor:pointer; transition:all 0.3s; max-width:420px; width:100%; }
.upload-box:hover { border-color:var(--rose); background:rgba(212,120,154,0.04); }
.upload-box h2 { font-family:'Playfair Display',serif; color:var(--gold); font-size:1.4rem; font-style:italic; margin:14px 0 8px; }
.upload-box p { color:var(--muted); font-size:0.9rem; font-style:italic; }
.btn-upload { background:linear-gradient(135deg,var(--deep-rose),var(--rose)); color:white; border:none; padding:13px 34px; border-radius:30px; font-family:'Cormorant Garamond',serif; font-size:1.05rem; cursor:pointer; transition:all 0.3s; }
.btn-upload:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(160,67,90,0.4); }

/* â”€â”€ LOADING â”€â”€ */
#loadScreen { position:fixed; inset:0; background:var(--bg); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:998; gap:20px; }
.spinner { width:38px; height:38px; border:2px solid rgba(201,168,76,0.15); border-top-color:var(--gold); border-radius:50%; animation:spin 0.9s linear infinite; }
@keyframes spin { to{transform:rotate(360deg)} }
.load-text { font-family:'Playfair Display',serif; font-size:1.3rem; color:var(--gold); font-style:italic; }
.load-sub { color:var(--muted); font-size:0.85rem; font-style:italic; }

/* â”€â”€ BOOKMARK MENU â”€â”€ */
.bk-menu { position:fixed; top:54px; right:14px; z-index:500; background:#1a0f14; border:1px solid var(--border-rose); border-radius:14px; padding:6px; min-width:190px; box-shadow:0 8px 32px rgba(0,0,0,0.5); backdrop-filter:blur(10px); animation:menuIn 0.2s ease; }
@keyframes menuIn { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }
.bk-menu-btn { display:block; width:100%; background:none; border:none; color:var(--cream); font-family:'Cormorant Garamond',serif; font-size:0.92rem; padding:9px 14px; text-align:left; cursor:pointer; border-radius:8px; transition:background 0.15s; }
.bk-menu-btn:hover { background:rgba(255,255,255,0.06); }
.bk-menu-btn.danger { color:rgba(212,120,154,0.8); }

/* â”€â”€ TOAST â”€â”€ */
.toast { position:fixed; bottom:70px; left:50%; transform:translateX(-50%); background:rgba(160,67,90,0.92); color:white; padding:9px 22px; border-radius:24px; font-family:'Cormorant Garamond',serif; font-size:0.88rem; font-style:italic; z-index:999; backdrop-filter:blur(8px); pointer-events:none; transition:opacity 0.4s ease; white-space:nowrap; opacity:0; }

/* â”€â”€ MODE TOGGLE â”€â”€ */
.mode-badge { font-size:0.65rem; letter-spacing:0.08em; text-transform:uppercase; color:var(--gold); opacity:0.6; padding:0 4px; }
</style>
</head>
<body>

<!-- UPLOAD -->
<div id="uploadPrompt">
  <div class="upload-box" onclick="document.getElementById('pdfInput').click()">
    <div style="font-size:2.8rem">ğŸ“–</div>
    <h2>Biblioteca de Lorena</h2>
    <p>Sube el PDF para empezar a leer</p>
  </div>
  <button class="btn-upload" onclick="document.getElementById('pdfInput').click()">Seleccionar PDF ğŸŒ¹</button>
  <input type="file" id="pdfInput" accept=".pdf" style="display:none" onchange="loadPDF(event)">
</div>

<!-- LOADING -->
<div id="loadScreen">
  <div class="spinner"></div>
  <p class="load-text">Abriendo tu libro...</p>
  <p class="load-sub">Un momento ğŸŒ¹</p>
</div>

<!-- TOPBAR -->
<div class="topbar" id="topbar" style="display:none">
  <div class="topbar-left">
    <span class="book-title" id="bookTitle">â€”</span>
    <span class="book-author" id="bookAuthor"></span>
  </div>
  <div class="topbar-right">
    <span class="page-ind" id="pageInd"></span>
    <button class="tb-btn" id="bookmarkBtn" style="display:none" onclick="handleBookmark()">ğŸ€</button>
    <button class="tb-btn" id="modeBtn" style="display:none" onclick="toggleMode()">ğŸ“– Modo lectura</button>
    <button class="tb-btn" onclick="goBack()">â† Volver</button>
  </div>
</div>

<!-- STAGE -->
<div class="stage" id="stage" style="display:none">

  <!-- MOBILE READER -->
  <div class="mobile-reader" id="mobileReader">
    <div class="mobile-pages" id="mobilePages">
      <div class="m-page" id="mPageA"><canvas id="mCanvasA"></canvas></div>
      <div class="m-page" id="mPageB"><canvas id="mCanvasB"></canvas></div>
    </div>
    <!-- Tap zones -->
    <div class="tap-zone tap-left"  onclick="mPrev()"><div class="tap-arrow">â€¹</div></div>
    <div class="tap-zone tap-right" onclick="mNext()"><div class="tap-arrow">â€º</div></div>
    <!-- Bottom -->
    <div class="mobile-bottom">
      <span class="mob-page-label" id="mobPct">0%</span>
      <div class="mob-progress-wrap"><div class="mob-progress-bar" id="mobBar"></div></div>
      <span class="mob-page-label" id="mobPages"></span>
    </div>
  </div>

  <!-- DESKTOP READER -->
  <div class="desktop-reader" id="desktopReader">
    <div class="book-wrap" id="bookWrap">
      <button class="desk-nav desk-prev" id="dPrev" onclick="dPrevPage()" disabled>â€¹</button>
      <div class="book" id="dBook">
        <div class="page-side page-left"  id="dPageLeft"> <canvas id="dCanvasLeft"></canvas>  <span class="page-num" id="dNumLeft"></span>  </div>
        <div class="spine"></div>
        <div class="page-side page-right" id="dPageRight"><canvas id="dCanvasRight"></canvas> <span class="page-num" id="dNumRight"></span> </div>
      </div>
      <button class="desk-nav desk-next" id="dNext" onclick="dNextPage()">â€º</button>
    </div>
  </div>

</div>

<!-- DESKTOP BOTTOM -->
<div class="desktop-bottom" id="deskBottom">
  <span class="desk-pct" id="dPct">0%</span>
  <div class="desk-progress-wrap"><div class="desk-progress-bar" id="dBar"></div></div>
  <span class="desk-page-label" id="dPages"></span>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pdfDoc = null;
let totalPages = 0;
let isMobile = window.innerWidth < 768;
let isAnimating = false;

// Mobile state
let mCurrentPage = 1; // 1-based

// Desktop state
let dCurrentSpread = 0;
let dPageWidth = 420;
let dPageHeight = 580;

// Book info
const libroActual = JSON.parse(localStorage.getItem('lorena_libro_actual') || 'null');
const PDF_NAME = libroActual ? libroActual.pdf_url : 'annas-arch-60021976a045.pdf';

// Bookmark
let bookmarkPage = null; // 1-based page number

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', async () => {
  // Set title
  if (libroActual) {
    document.getElementById('bookTitle').textContent = libroActual.titulo;
    document.getElementById('bookAuthor').textContent = libroActual.autor || '';
  }

  // Load saved bookmark
  const bk = localStorage.getItem('lorena_bk_' + PDF_NAME);
  if (bk !== null) bookmarkPage = parseInt(bk);

  // Detect mobile â€” respeta preferencia guardada
  const savedMode = localStorage.getItem('lorena_reader_mode');
  if (savedMode) {
    isMobile = savedMode === 'mobile';
  } else {
    isMobile = window.innerWidth < 768;
  }

  // Auto-load PDF
  try {
    const response = await fetch(PDF_NAME);
    if (response.ok) {
      const blob = await response.blob();
      const file = new File([blob], PDF_NAME, { type: 'application/pdf' });
      document.getElementById('uploadPrompt').classList.add('hidden');
      await startLoad(file);
      return;
    }
  } catch(e) {}
  // Show upload screen if fetch fails
});

// Drag & drop
const up = document.getElementById('uploadPrompt');
up.addEventListener('dragover', e => e.preventDefault());
up.addEventListener('drop', e => { e.preventDefault(); const f = e.dataTransfer.files[0]; if (f) startLoad(f); });

function loadPDF(e) { const f = e.target.files[0]; if (f) startLoad(f); }

// â”€â”€ START LOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startLoad(file) {
  document.getElementById('uploadPrompt').classList.add('hidden');
  document.getElementById('loadScreen').style.display = 'flex';
  if (libroActual) {
    document.getElementById('bookTitle').textContent = libroActual.titulo;
  } else {
    document.getElementById('bookTitle').textContent = file.name.replace('.pdf','').replace(/-/g,' ');
  }
  try {
    const url = URL.createObjectURL(file);
    pdfDoc = await pdfjsLib.getDocument(url).promise;
    totalPages = pdfDoc.numPages;
    localStorage.setItem('lorena_total_' + PDF_NAME, totalPages);

    document.getElementById('loadScreen').style.display = 'none';
    document.getElementById('topbar').style.display = 'flex';
    document.getElementById('stage').style.display = 'flex';
    document.getElementById('bookmarkBtn').style.display = 'inline-flex';
    document.getElementById('modeBtn').style.display = 'inline-flex';
    updateModeBtn();

    if (isMobile) {
      await initMobile();
    } else {
      await initDesktop();
    }
  } catch(e) {
    alert('Error al cargar el PDF.');
    location.reload();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBILE MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initMobile() {
  document.getElementById('mobileReader').classList.add('active');

  // Restore saved page
  const saved = parseInt(localStorage.getItem('lorena_page_' + PDF_NAME)) || 1;
  mCurrentPage = (saved >= 1 && saved <= totalPages) ? saved : 1;

  await mRenderAll();
  if (mCurrentPage > 1) showToast(`ğŸ“– Continuando en la pÃ¡gina ${mCurrentPage}`);

  // Touch/swipe support
  let startX = 0;
  const pages = document.getElementById('mobilePages');
  pages.addEventListener('touchstart', e => { startX = e.touches[0].clientX; }, { passive:true });
  pages.addEventListener('touchend', e => {
    const diff = startX - e.changedTouches[0].clientX;
    if (Math.abs(diff) > 50) { diff > 0 ? mNext() : mPrev(); }
  }, { passive:true });
}

// â”€â”€ MOBILE: dos canvas, swap limpio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// "active" = el canvas visible ahora, "standby" = el que se prepara detrÃ¡s
let mActive = 'A'; // 'A' o 'B'

function mActiveCanvas()  { return document.getElementById('mCanvas' + mActive); }
function mStandbyCanvas() { return document.getElementById('mCanvas' + (mActive === 'A' ? 'B' : 'A')); }
function mActivePage()    { return document.getElementById('mPage'   + mActive); }
function mStandbyPage()   { return document.getElementById('mPage'   + (mActive === 'A' ? 'B' : 'A')); }

async function mRenderPage(canvas, pageNum) {
  if (pageNum < 1 || pageNum > totalPages) { canvas.width=1; canvas.height=1; return; }
  const page = await pdfDoc.getPage(pageNum);
  const container = document.getElementById('mobilePages');
  const maxW = container.clientWidth - 16;
  const maxH = container.clientHeight - 16;
  const vp0 = page.getViewport({ scale:1 });
  const scale = Math.min(maxW / vp0.width, maxH / vp0.height) * window.devicePixelRatio;
  const vp = page.getViewport({ scale });
  canvas.width = vp.width; canvas.height = vp.height;
  canvas.style.width  = (vp.width  / window.devicePixelRatio) + 'px';
  canvas.style.height = (vp.height / window.devicePixelRatio) + 'px';
  await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
}

async function mShow(pageNum) {
  // Render into standby canvas (hidden)
  const standby = mStandbyCanvas();
  const standbyPage = mStandbyPage();
  const activePage  = mActivePage();

  await mRenderPage(standby, pageNum);

  // Position standby off screen (right or left based on direction)
  const goingForward = pageNum > mCurrentPage;
  standbyPage.style.transition = 'none';
  standbyPage.style.transform  = `translateX(${goingForward ? '100%' : '-100%'})`;
  standbyPage.style.opacity    = '1';
  standbyPage.style.zIndex     = '2';

  // Force reflow so transition fires
  standbyPage.getBoundingClientRect();

  // Animate both
  const dur = '0.32s';
  standbyPage.style.transition = `transform ${dur} ease, opacity ${dur} ease`;
  activePage.style.transition  = `transform ${dur} ease, opacity ${dur} ease`;

  standbyPage.style.transform = 'translateX(0)';
  activePage.style.transform  = `translateX(${goingForward ? '-100%' : '100%'})`;
  activePage.style.opacity    = '0';

  await wait(340);

  // Finalize â€” hide old active
  activePage.style.transition = 'none';
  activePage.style.transform  = 'translateX(100%)';
  activePage.style.zIndex     = '1';

  // Swap active
  mActive = mActive === 'A' ? 'B' : 'A';
  mCurrentPage = pageNum;
  localStorage.setItem('lorena_page_' + PDF_NAME, mCurrentPage);
  mUpdateUI();
}

async function mNext() {
  if (isAnimating || mCurrentPage >= totalPages) return;
  isAnimating = true;
  await mShow(mCurrentPage + 1);
  isAnimating = false;
}

async function mPrev() {
  if (isAnimating || mCurrentPage <= 1) return;
  isAnimating = true;
  await mShow(mCurrentPage - 1);
  isAnimating = false;
}

async function mRenderAll() {
  // Render current page into active canvas, show it
  const activePage = mActivePage();
  activePage.style.transition = 'none';
  activePage.style.transform  = 'translateX(0)';
  activePage.style.opacity    = '1';
  activePage.style.zIndex     = '2';
  // Hide standby
  const standbyPage = mStandbyPage();
  standbyPage.style.transition = 'none';
  standbyPage.style.transform  = 'translateX(100%)';
  standbyPage.style.opacity    = '0';
  standbyPage.style.zIndex     = '1';
  await mRenderPage(mActiveCanvas(), mCurrentPage);
  mUpdateUI();
}

function mUpdateUI() {
  const pct = Math.round((mCurrentPage / totalPages) * 100);
  document.getElementById('mobBar').style.width = pct + '%';
  document.getElementById('mobPct').textContent = pct + '%';
  document.getElementById('mobPages').textContent = `${mCurrentPage} / ${totalPages}`;
  document.getElementById('pageInd').textContent = `${mCurrentPage} de ${totalPages}`;
  updateBookmarkBtn();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DESKTOP MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initDesktop() {
  document.getElementById('desktopReader').classList.add('active');
  document.getElementById('deskBottom').classList.add('active');

  // Page size
  const firstPage = await pdfDoc.getPage(1);
  const vp0 = firstPage.getViewport({ scale:1 });
  const ratio = vp0.height / vp0.width;
  const maxH = Math.min(window.innerHeight - 130, 640);
  dPageHeight = maxH; dPageWidth = Math.round(maxH / ratio);
  const maxW = Math.floor((window.innerWidth - 200) / 2);
  if (dPageWidth > maxW) { dPageWidth = maxW; dPageHeight = Math.round(maxW * ratio); }
  applyDeskSize();

  // Restore saved page
  const saved = parseInt(localStorage.getItem('lorena_page_' + PDF_NAME)) || 1;
  const startPage = (saved >= 1 && saved <= totalPages) ? saved : 1;
  dCurrentSpread = Math.floor((startPage - 1) / 2);

  await dRenderSpread(dCurrentSpread, false);
  if (startPage > 1) showToast(`ğŸ“– Continuando en la pÃ¡gina ${startPage}`);

  // Keyboard nav
  document.addEventListener('keydown', e => {
    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') dNextPage();
    if (e.key === 'ArrowLeft'  || e.key === 'ArrowUp')   dPrevPage();
  });
}

function applyDeskSize() {
  ['dPageLeft','dPageRight'].forEach(id => {
    const el = document.getElementById(id);
    el.style.width  = dPageWidth + 'px';
    el.style.height = dPageHeight + 'px';
  });
}

async function dRenderPage(canvas, pageNum) {
  if (pageNum < 1 || pageNum > totalPages) {
    const ctx = canvas.getContext('2d');
    canvas.width  = dPageWidth  * window.devicePixelRatio;
    canvas.height = dPageHeight * window.devicePixelRatio;
    ctx.fillStyle = '#fdf8ee'; ctx.fillRect(0,0,canvas.width,canvas.height);
    canvas.style.width  = dPageWidth  + 'px';
    canvas.style.height = dPageHeight + 'px';
    return;
  }
  const page = await pdfDoc.getPage(pageNum);
  const scale = (dPageWidth / page.getViewport({scale:1}).width) * window.devicePixelRatio;
  const vp = page.getViewport({ scale });
  canvas.width  = vp.width; canvas.height = vp.height;
  canvas.style.width  = dPageWidth  + 'px';
  canvas.style.height = dPageHeight + 'px';
  await page.render({ canvasContext:canvas.getContext('2d'), viewport:vp }).promise;
}

async function dRenderSpread(spreadIndex, animate, direction) {
  const L = spreadIndex * 2 + 1;
  const R = spreadIndex * 2 + 2;
  if (animate) {
    await dAnimateFlip(spreadIndex, direction);
  } else {
    await Promise.all([
      dRenderPage(document.getElementById('dCanvasLeft'),  L),
      dRenderPage(document.getElementById('dCanvasRight'), R),
    ]);
  }
  dCurrentSpread = spreadIndex;
  const savedPage = spreadIndex * 2 + 1;
  localStorage.setItem('lorena_page_' + PDF_NAME, savedPage);
  dUpdateUI();
}

async function dAnimateFlip(targetSpread, direction) {
  if (isAnimating) return; isAnimating = true;
  const book = document.getElementById('dBook');
  const flipEl = document.createElement('div');
  flipEl.className = `flip-container flip-${direction === 'forward' ? 'right' : 'left'}`;
  flipEl.style.cssText = `top:0;height:${dPageHeight}px;width:${dPageWidth}px;perspective:2000px;`;
  const flipPage = document.createElement('div'); flipPage.className = 'flip-page';
  const flipCanvas = document.createElement('canvas'); flipPage.appendChild(flipCanvas);
  flipEl.appendChild(flipPage); book.appendChild(flipEl);
  const turningPageNum = direction === 'forward' ? dCurrentSpread*2+2 : targetSpread*2+1;
  await dRenderPage(flipCanvas, turningPageNum);
  flipCanvas.style.width  = dPageWidth  + 'px';
  flipCanvas.style.height = dPageHeight + 'px';
  await Promise.all([
    dRenderPage(document.getElementById('dCanvasLeft'),  targetSpread*2+1),
    dRenderPage(document.getElementById('dCanvasRight'), targetSpread*2+2),
  ]);
  flipEl.classList.add(direction === 'forward' ? 'animating-forward' : 'animating-back');
  await wait(680);
  book.removeChild(flipEl);
  isAnimating = false;
}

function dUpdateUI() {
  const L = dCurrentSpread*2+1, R = dCurrentSpread*2+2;
  document.getElementById('dNumLeft').textContent  = L <= totalPages ? L : '';
  document.getElementById('dNumRight').textContent = R <= totalPages ? R : '';
  const label = R <= totalPages ? `PÃ¡ginas ${L}â€“${R} de ${totalPages}` : `PÃ¡gina ${L} de ${totalPages}`;
  document.getElementById('dPages').textContent = label;
  document.getElementById('pageInd').textContent = label;
  const pct = Math.min(Math.round((R / totalPages)*100), 100);
  document.getElementById('dBar').style.width = pct + '%';
  document.getElementById('dPct').textContent = pct + '%';
  document.getElementById('dPrev').disabled = dCurrentSpread === 0;
  document.getElementById('dNext').disabled = (dCurrentSpread+1)*2 >= totalPages;
  updateBookmarkBtn();
}

async function dNextPage() {
  if (isAnimating) return;
  const next = dCurrentSpread + 1;
  if (next*2 >= totalPages) return;
  await dRenderSpread(next, true, 'forward');
}

async function dPrevPage() {
  if (isAnimating) return;
  const prev = dCurrentSpread - 1;
  if (prev < 0) return;
  await dRenderSpread(prev, true, 'back');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOKMARK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function currentPageNum() {
  return isMobile ? mCurrentPage : dCurrentSpread * 2 + 1;
}

function handleBookmark() {
  closeBookmarkMenu();
  const cur = currentPageNum();
  if (bookmarkPage === null) {
    setBookmark(cur); return;
  }
  // Show menu
  const isHere = bookmarkPage === cur || (!isMobile && bookmarkPage === cur + 1);
  const menu = document.createElement('div');
  menu.id = 'bkMenu'; menu.className = 'bk-menu';
  menu.innerHTML = `
    ${!isHere ? `<button class="bk-menu-btn" onclick="goToBookmark()">ğŸ“– Ir a pÃ¡g. ${bookmarkPage}</button>` : ''}
    <button class="bk-menu-btn" onclick="setBookmark(${cur});closeBookmarkMenu()">ğŸ€ Mover marcador aquÃ­</button>
    <button class="bk-menu-btn danger" onclick="removeBookmark()">âœ• Quitar marcador</button>
  `;
  document.body.appendChild(menu);
  setTimeout(() => document.addEventListener('click', outsideBk), 10);
}

function setBookmark(page) {
  bookmarkPage = page;
  localStorage.setItem('lorena_bk_' + PDF_NAME, page);
  updateBookmarkBtn();
  showToast(`ğŸ€ Marcador en pÃ¡gina ${page}`);
}

function removeBookmark() {
  bookmarkPage = null;
  localStorage.removeItem('lorena_bk_' + PDF_NAME);
  updateBookmarkBtn();
  closeBookmarkMenu();
  showToast('ğŸ€ Marcador quitado');
}

async function goToBookmark() {
  closeBookmarkMenu();
  if (bookmarkPage === null) return;
  if (isMobile) {
    const target = bookmarkPage;
    mCurrentPage = target - 1; // mShow will increment from here via comparison
    await mShow(target);
  } else {
    const targetSpread = Math.floor((bookmarkPage - 1) / 2);
    if (targetSpread !== dCurrentSpread) {
      const dir = targetSpread > dCurrentSpread ? 'forward' : 'back';
      await dRenderSpread(targetSpread, true, dir);
    }
  }
}

function updateBookmarkBtn() {
  const btn = document.getElementById('bookmarkBtn');
  if (!btn) return;
  const cur = currentPageNum();
  const onBk = bookmarkPage !== null && (bookmarkPage === cur || (!isMobile && bookmarkPage === cur+1));
  if (bookmarkPage === null) {
    btn.textContent = 'ğŸ€ Marcar'; btn.classList.remove('bookmark-active');
  } else if (onBk) {
    btn.textContent = 'ğŸ€ AquÃ­'; btn.classList.add('bookmark-active');
  } else {
    btn.textContent = `ğŸ€ p.${bookmarkPage}`; btn.classList.add('bookmark-active');
  }
}

function closeBookmarkMenu() {
  const m = document.getElementById('bkMenu'); if (m) m.remove();
  document.removeEventListener('click', outsideBk);
}
function outsideBk(e) {
  const m = document.getElementById('bkMenu');
  if (m && !m.contains(e.target) && e.target.id !== 'bookmarkBtn') closeBookmarkMenu();
}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.opacity = '1';
  clearTimeout(t._t);
  t._t = setTimeout(() => t.style.opacity = '0', 2500);
}

function goBack() { window.location.href = 'index.html'; }

// â”€â”€ MODE TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleMode() {
  isMobile = !isMobile;
  localStorage.setItem('lorena_reader_mode', isMobile ? 'mobile' : 'desktop');

  // Hide both readers
  document.getElementById('mobileReader').classList.remove('active');
  document.getElementById('desktopReader').classList.remove('active');
  document.getElementById('deskBottom').classList.remove('active');

  // Get current page to restore position
  const curPage = isMobile
    ? dCurrentSpread * 2 + 1
    : mCurrentPage;

  if (isMobile) {
    mCurrentPage = curPage;
    initMobile();
  } else {
    dCurrentSpread = Math.floor((curPage - 1) / 2);
    initDesktop();
  }
  updateModeBtn();
}

function updateModeBtn() {
  const btn = document.getElementById('modeBtn');
  if (!btn) return;
  btn.textContent = isMobile ? 'ğŸ“š Modo libro' : 'ğŸ“– Modo lectura';
}
</script>
</body>
</html>